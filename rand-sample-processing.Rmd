---
title: "Randomize Sample Processing"
author: "Sarah Tanja"
date: "4/10/2023"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Load packages

```{r}
if ("rqdatatable" %in% rownames(installed.packages()) == 'FALSE') install.packages("rqdatatable")
```


## Include packages

```{r}
library(tidyverse)
library(readr)
library(rqdatatable)
```

# Sub-sample selection
I need to select a sub-sample of 20 from a total of 140 samples, process them, and send them off for sequencing to confirm that it is worthwhile to sequence more using the same protocols. However, I want to make sure that the sub-sample contains a spread of treatments so that I can do a preliminary analysis, and I want to randomize as much as possible to account for batch effects. I have duplicates for each of my 140 samples. I am not concerned about 'using up' a sample. Each sample is split into two 1.5mL cryo-tubes labelled 'a' and 'b' and can be used for other analyses or as technical replicates (meaning there are 280 total frozen cryo-vials to work with).

I've chosen 20 as the sub-sample because the Zymo Quick DNA/RNA Miniprep Plus kit I'm using comes with preps in multiples of 10 (or 50), and the minimum number of samples to run without incurring an additional fee from UT Austin's Genomics center is 20.

I would like to select a total of 20 samples that meet the following criteria:

| number of samples | treatment group      |
|-------------------|----------------------|
| 4                 | environmental & kbay |
| 4                 | control & ambient    |
| 4                 | control & hot        |
| 4                 | peak & ambient       |
| 4                 | peak & hot           |
| Total = 20        |                      |

I will aim to randomize my sample processing within these bounds.

# Load in metadata

```{r metadata}
metadata <- read_csv("data/metadata.csv")
```

# Extraction #1
set.seed makes output the same when re-run 
This should result in 20 samples from the environmental group and 40 samples of each treatment group, equaling a total of 100 samples. 
Now we want to randomly select 2 samples from each of the 5 groups, for a total of 10 samples to process together with a Zymo 10-prep kit.
```{r}
set.seed(1) 
extr1 <- 
  metadata %>%
   filter(
      pae_treatment == "environmental" & cryo_rep == "a" |
      pae_treatment == "control" & temp_treatment == "ambient" & cryo_rep == "a" |
      pae_treatment == "control" & temp_treatment == "hot" & cryo_rep == "a" |
      pae_treatment == "peak" & temp_treatment == "ambient" & cryo_rep == "a" |
      pae_treatment == "peak" & temp_treatment == "hot" & cryo_rep == "a"
         ) %>% group_by(pae_treatment, temp_treatment) %>% slice_sample(n=2) 

extr1 <- extr1 %>% 
  mutate(extraction_id = 'extr-1')

print(extr1[ , c("cryo_id","extraction_id")])
```

These 10 samples are the first that we will process, and will be assigned 'extr1'as their extraction_id.

## Add extr-1 to metadata
Update metadata to reflect this, by renaming 'live_metadata' and joining the 'extr1' tibble to it 
```{r}
live_metadata <- metadata %>% left_join(extr1)
```

# Extraction #2
Now we will randomly select the next batch of 10 samples, excluding the ones we already processed
```{r}
set.seed(100)
extr2 <- 
  live_metadata %>%
   filter(
      extraction_id == NA |
      pae_treatment == "environmental" & cryo_rep == "a" |
      pae_treatment == "control" & temp_treatment == "ambient" & cryo_rep == "a" |
      pae_treatment == "control" & temp_treatment == "hot" & cryo_rep == "a" |
      pae_treatment == "peak" & temp_treatment == "ambient" & cryo_rep == "a" |
      pae_treatment == "peak" & temp_treatment == "hot" & cryo_rep == "a"
         ) %>% group_by(pae_treatment, temp_treatment) %>% slice_sample(n=2) 

extr2 <- extr2 %>% 
  mutate(extraction_id = 'extr-2')

print(extr2[ , c("cryo_id","extraction_id")])
```
## Add extr-2 to live_metadata
```{r}
live_metadata <- natural_join(live_metadata, extr2,
                              by = c('cryo_id', 
                                     'colony',
                                     'pae_treatment',
                                     'temp_treatment',
                                     'tank',
                                     'cryo_rep', 
                                     'pae_ugL',
                                     'freeze_date',
                                     'cull_notes'), 
                              jointype = 'FULL')
```


